---
import Layout from './Layout.astro'
import RelatedPhotos from '../components/RelatedPhotos.astro'
import {Image, Picture} from '@astrojs/image/components'
import {getImage} from '@astrojs/image'

export async function getStaticPaths() {
  const photos = await Astro.glob('../pages/photos/*.md')

  return photos.map(photo => ({
    params: {
      slug: photo.frontmatter.slug,
    },
    props: {
      photo,
    },
  }))
}

const {frontmatter, url} = Astro.props

const currentCategories =
  frontmatter.categories && frontmatter.categories.map(category => category)

const photos = await Astro.glob('../pages/photos/*.md')
let filteredPhotos = []
const related = photos.map(
  i =>
    i.frontmatter.categories &&
    i.frontmatter.title !== frontmatter.title &&
    i.frontmatter.categories.filter(element => {
      if (currentCategories && currentCategories.includes(element)) {
        const obj = {
          layout: i.frontmatter.layout,
          title: i.frontmatter.title,
          slug: i.url,
          image: i.frontmatter.image,
        }
        filteredPhotos.push(obj)
      }
    })
)
const filteredUnique = [
  ...new Map(filteredPhotos.map(item => [item['slug'], item])).values(),
]
---

<Layout
  siteTitle={frontmatter.title}
  description={frontmatter.description}
  socialImage={frontmatter.image}
>
  <article
    class="w-11/12 md:w-3/4 mx-auto p-6 grid grid-cols-1 gap-6 my-6 md:my-20 text-sm md:text-base"
  >
    <header class="flex flex-col gap-4 border-b border-b-gray-300 pb-6">
      <h1 class="text-2xl md:text-3xl font-black">{frontmatter.title}</h1>
      <!-- {
        frontmatter.date && (
          <p class="italic">
            Posted on {new Date(frontmatter.date).toLocaleDateString()}
          </p>
        )
      }
 -->
      {
        frontmatter.camera.model && (
          <div class="italic inline-flex items-center text-sm md:text-base">
            <img
              class="w-5 h-5 mr-1"
              src="/images/icons/photos.svg"
              aria-hidden="true"
              height="24"
              width="24"
              alt=""
            />
            {frontmatter.camera.model}

            {frontmatter.camera.lens && ` with ${frontmatter.camera.lens}`}
          </div>
        )
      }

      <p class="flex gap-2">
        {
          currentCategories &&
            currentCategories.map(category => (
              <a
                class="px-3 border bg-white rounded-full hover:ring-4 hover:ring-pink-500"
                href={`/photos/${category.toLowerCase().replaceAll(' ', '-')}`}
              >
                {category}
              </a>
            ))
        }
      </p>
    </header>

    <figure>
      <Image
        class="max-w-full"
        src={frontmatter.image}
        alt={frontmatter.title}
        width={1500}
        aspectRatio={frontmatter.aspect ? frontmatter.aspect : `16:10`}
      />
      <figcaption class="italic flex text-sm md:text-base pt-1">
        <span>{frontmatter.title}</span>

        {frontmatter.author && <span>, {frontmatter.author}</span>}

        {
          frontmatter.date && (
            <date>, {new Date(frontmatter.date).toLocaleDateString()}</date>
          )
        }
      </figcaption>
    </figure>

    <div class="space-y-6 my-4 md:my-8">
      <slot />
    </div>
    <!-- {`/src/images/${frontmatter.image}`} -->

    {
      filteredPhotos.length > 0 && (
        <RelatedPhotos
          title="You might also like these"
          content={filteredUnique}
        />
      )
    }
  </article>
</Layout>
